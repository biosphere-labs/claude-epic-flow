---
allowed-tools: Bash, Write, Read, LS, AskUserQuestion
---

# Initialize PM Workflow

Set up the workflow/ directory structure and project configuration for a new project.

## Usage
```
/pm:init
```

## Instructions

### 1. Check Current State

```bash
echo "=== Checking project state ==="

# Check if git repo exists
if [ -d ".git" ]; then
  echo "✓ Git repository found"
  REMOTE_URL=$(git remote get-url origin 2>/dev/null || echo "")
  if [ -n "$REMOTE_URL" ]; then
    echo "✓ Remote origin: $REMOTE_URL"
  else
    echo "✗ No remote origin configured"
  fi
else
  echo "✗ Not a git repository"
fi

# Check if already initialized
if [ -f ".claude/project.yaml" ]; then
  echo "⚠️  Project already configured:"
  cat .claude/project.yaml
fi

if [ -d "workflow" ]; then
  echo "⚠️  workflow/ directory exists"
fi
```

If project.yaml exists, ask user if they want to reconfigure.

### 2. Gather Project Name

Use `AskUserQuestion` to get the project name:
- Ask for a short identifier (e.g., "my-app", "weave")
- This is used for display and API integrations

### 3. Setup Git & GitHub (Optional)

Use `AskUserQuestion` to determine GitHub setup:

**Options:**
1. **Use existing remote** - Auto-detect from `git remote get-url origin`
2. **Skip GitHub** - Local only, no remote integration
3. **Create new repo** - Initialize git and create GitHub repo (if not exists)

#### If using existing remote:
```bash
REMOTE_URL=$(git remote get-url origin 2>/dev/null)
# Extract owner/repo from URL
GITHUB_REPO=$(echo "$REMOTE_URL" | sed 's|.*github.com[:/]||' | sed 's|\.git$||')
echo "Using repository: $GITHUB_REPO"
```

#### If skipping GitHub:
```bash
GITHUB_REPO=""
echo "Skipping GitHub integration"
```

### 4. Setup Project Board (If GitHub enabled)

If GitHub repo is configured, offer to connect a project board:

```bash
if [ -n "$GITHUB_REPO" ]; then
  # Get the org/user from repo
  OWNER=$(echo "$GITHUB_REPO" | cut -d'/' -f1)

  echo "Fetching projects for $OWNER..."

  # List projects (user or org)
  PROJECTS=$(gh project list --owner "$OWNER" --format json 2>/dev/null || echo "[]")

  if [ "$PROJECTS" != "[]" ]; then
    echo "Available projects:"
    echo "$PROJECTS" | jq -r '.projects[] | "\(.number): \(.title)"'
  else
    echo "No projects found for $OWNER"
  fi
fi
```

Use `AskUserQuestion` to:
1. Select a project by number
2. Or skip project board integration

#### If project selected, get field IDs:
```bash
PROJECT_NUMBER="{selected_number}"

# Get project ID
PROJECT_DATA=$(gh project view $PROJECT_NUMBER --owner "$OWNER" --format json 2>/dev/null)
PROJECT_ID=$(echo "$PROJECT_DATA" | jq -r '.id')

echo "Project ID: $PROJECT_ID"

# Get Status field and its options
FIELDS=$(gh project field-list $PROJECT_NUMBER --owner "$OWNER" --format json 2>/dev/null)

# Find Status field
STATUS_FIELD=$(echo "$FIELDS" | jq -r '.fields[] | select(.name == "Status")')
STATUS_FIELD_ID=$(echo "$STATUS_FIELD" | jq -r '.id')

echo "Status Field ID: $STATUS_FIELD_ID"

# Get status options (ToDo, In Progress, etc.)
STATUS_OPTIONS=$(echo "$STATUS_FIELD" | jq -r '.options[]? | "\(.name): \(.id)"')
echo "Status options:"
echo "$STATUS_OPTIONS"

# Parse individual status IDs
TODO_ID=$(echo "$STATUS_FIELD" | jq -r '.options[]? | select(.name | test("todo|backlog"; "i")) | .id' | head -1)
IN_PROGRESS_ID=$(echo "$STATUS_FIELD" | jq -r '.options[]? | select(.name | test("progress|doing"; "i")) | .id' | head -1)
IN_REVIEW_ID=$(echo "$STATUS_FIELD" | jq -r '.options[]? | select(.name | test("review"; "i")) | .id' | head -1)
DONE_ID=$(echo "$STATUS_FIELD" | jq -r '.options[]? | select(.name | test("done|complete"; "i")) | .id' | head -1)
```

### 5. Detect Default Branch

```bash
if [ -n "$GITHUB_REPO" ]; then
  # Get default branch from GitHub
  DEFAULT_BRANCH=$(gh repo view "$GITHUB_REPO" --json defaultBranchRef -q '.defaultBranchRef.name' 2>/dev/null || echo "main")
else
  # Check local branches
  DEFAULT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "main")
fi
echo "Default branch: $DEFAULT_BRANCH"
```

### 6. Create Project Configuration

Create `.claude/project.yaml`:

```bash
mkdir -p .claude

cat > .claude/project.yaml << 'EOF'
# Project-specific configuration for Claude Code PM
# Generated by /pm:init

project:
  name: "{PROJECT_NAME}"
  description: ""

EOF

# Add GitHub section if configured
if [ -n "$GITHUB_REPO" ]; then
cat >> .claude/project.yaml << 'EOF'
github:
  repo: "{GITHUB_REPO}"
  default_branch: "{DEFAULT_BRANCH}"

EOF
fi

# Add project board section if configured
if [ -n "$PROJECT_ID" ]; then
cat >> .claude/project.yaml << 'EOF'
# GitHub Project Board settings
project_board:
  project_number: {PROJECT_NUMBER}
  project_owner: "{OWNER}"
  project_id: "{PROJECT_ID}"
  status_field_id: "{STATUS_FIELD_ID}"
  # Kanban column option IDs
  ToDo_status_id: "{TODO_ID}"
  In_Progress_status_id: "{IN_PROGRESS_ID}"
  In_Review_status_id: "{IN_REVIEW_ID}"
  Done_status_id: "{DONE_ID}"

EOF
fi

# Add API keys section (commented out)
cat >> .claude/project.yaml << 'EOF'
# API keys for project-specific integrations
# api_keys:
#   website_url: "https://example.com/api/ingest"
#   website_key: "YOUR_API_KEY"
EOF
```

### 7. Create Directory Structure

```bash
# Core workflow folders
mkdir -p workflow/prds/.archived
mkdir -p workflow/epics/.archived
mkdir -p workflow/bugfixes/.archived
mkdir -p workflow/bugfixes/observations
mkdir -p workflow/brainstorms/.archived
mkdir -p workflow/context

# Add .gitkeep to empty folders
for dir in workflow/prds/.archived workflow/epics/.archived workflow/bugfixes/.archived workflow/brainstorms/.archived; do
  touch "$dir/.gitkeep"
done
```

### 8. Create Context Placeholders

Create minimal context files if they don't exist:

**workflow/context/project-overview.md:**
```markdown
# Project Overview

## Purpose
[Describe what this project does]

## Key Features
- [Feature 1]
- [Feature 2]

## Tech Stack
- [Technology 1]
- [Technology 2]
```

**workflow/context/tech-context.md:**
```markdown
# Technical Context

## Architecture
[Describe the architecture]

## Key Patterns
[Describe patterns used]

## Dependencies
[List key dependencies]
```

### 9. Update .gitignore

```bash
if ! grep -q "workflow/\*\*/\.archived" .gitignore 2>/dev/null; then
  echo "" >> .gitignore
  echo "# Workflow archives (optional - uncomment to ignore)" >> .gitignore
  echo "# workflow/**/.archived/" >> .gitignore
fi
```

### 10. Output Summary

```
✅ PM workflow initialized

Project: {PROJECT_NAME}
```

If GitHub configured:
```
GitHub: {GITHUB_REPO}
Branch: {DEFAULT_BRANCH}
```

If project board configured:
```
Project Board: #{PROJECT_NUMBER} ({project_title})
  - ToDo, In Progress, In Review, Done columns mapped
```

If no GitHub:
```
GitHub: Not configured (local only)
```

```
Created:
  .claude/
  └── project.yaml

  workflow/
  ├── prds/
  ├── epics/
  ├── bugfixes/
  ├── brainstorms/
  └── context/

Next steps:
  1. Review .claude/project.yaml
  2. Run /context:create to generate context docs
  3. Run /pm:prd-new <name> to start your first feature
```

## Notes

- Auto-detects GitHub repo from git remote
- Uses `gh` CLI to fetch project board IDs automatically
- Supports local-only projects (no GitHub)
- Safe to run multiple times (will ask before overwriting)
- Project board connection is optional
